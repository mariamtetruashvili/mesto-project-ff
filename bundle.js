(()=>{"use strict";var e={};function t(e,t,r,o,n,c){const s=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),a=s.querySelector(".card__image"),i=s.querySelector(".card__title"),u=s.querySelector(".card__delete-button"),p=s.querySelector(".card__like-button"),l=s.querySelector(".card__like-counter"),d=document.querySelector(".popup_type_delete-confirm"),m=d.querySelector('[name="confirm-delete"]');return a.src=e.link,a.alt=e.name,i.textContent=e.name,l.textContent=e.likes?.length||0,function(e,t){return Array.isArray(e.likes)&&e.likes.some((e=>e._id===t))}(e,t)&&p.classList.add("card__like-button_is-active"),t!==r&&u.remove(),u.addEventListener("click",(t=>{t.stopPropagation(),d.classList.add("popup_is-opened");const r=t=>{t.preventDefault(),o(e._id,s),d.classList.remove("popup_is-opened"),m.removeEventListener("submit",r)};m.addEventListener("submit",r)})),a.addEventListener("click",(()=>c(e.name,e.link))),p.addEventListener("click",(()=>{n(e._id,p,l)})),s}function r(e,t){fetch(`https://nomoreparties.co/v1/wff-cohort-39/cards/${e}`,{method:"DELETE",headers:{authorization:"a937dc3d-a867-499c-a146-3d115cd1c807"}}).then((e=>{if(!e.ok)return e.json().then((e=>{throw e}));t.remove()})).catch((e=>{console.error("Ошибка при удалении карточки:",e)}))}function o(e,t,r){const o=t.classList.contains("card__like-button_is-active");fetch(`https://nomoreparties.co/v1/wff-cohort-39/cards/likes/${e}`,{method:o?"DELETE":"PUT",headers:{authorization:"a937dc3d-a867-499c-a146-3d115cd1c807"}}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{r.textContent=e.likes.length,t.classList.toggle("card__like-button_is-active",!o)})).catch((e=>{console.error("Ошибка при изменении лайка:",e)}))}function n(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",s)}function c(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",s)}function s(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&c(e)}}function a(e,t,r,o){const n=e.querySelector(`#${t.id}-error`);n&&(t.classList.add(o.inputErrorClass),n.textContent=r,n.classList.add(o.errorClass))}function i(e,t,r){const o=e.querySelector(`#${t.id}-error`);o&&(t.classList.remove(r.inputErrorClass),o.textContent="",o.classList.remove(r.errorClass))}function u(e,t,r){const o=t.value.trim(),n="url"===t.type;if(!o&&!t.matches(":focus"))return i(e,t,r),!1;if(!o)return a(e,t,function(e){return e.dataset.errorMessage||"Вы пропустили это поле."}(t),r),!1;if(!n){const n=parseInt(t.dataset.minLength,10)||2,c=parseInt(t.dataset.maxLength,10)||30;if(o.length<n||o.length>c)return a(e,t,`Должно быть от ${n} до ${c} символов`,r),!1}return["name","description","place-name"].includes(t.name)&&!/^[a-zA-Zа-яА-ЯёЁ\s-]+$/.test(o)?(a(e,t,"Разрешены только латинские, кириллические буквы, дефисы и пробелы",r),!1):n&&!(e=>{try{return new URL(e),!0}catch(e){return!1}})(o)?(a(e,t,"Введите корректный адрес ссылки.",r),!1):(i(e,t,r),!0)}function p(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);if(!o)return;const n=r.every((r=>""!==r.value.trim()&&u(e,r,t)));o.disabled=!n,o.classList.toggle(t.inactiveButtonClass,!n)}e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var r=e.g.document;if(!t&&r&&(r.currentScript&&"SCRIPT"===r.currentScript.tagName.toUpperCase()&&(t=r.currentScript.src),!t)){var o=r.getElementsByTagName("script");if(o.length)for(var n=o.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=o[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})(),e.p,e.p;const l={baseUrl:"https://nomoreparties.co/v1/wff-cohort-39",headers:{authorization:"a937dc3d-a867-499c-a146-3d115cd1c807","Content-Type":"application/json"}};function d(){return fetch(`${l.baseUrl}/users/me`,{headers:l.headers}).then(m)}function m(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}const _=document.querySelector(".places__list"),y=document.querySelector(".popup_type_edit"),f=document.querySelector(".popup_type_new-card"),h=document.querySelector(".popup_type_image"),v=(h.querySelector(".popup__image"),h.querySelector(".popup__caption"),document.querySelector(".profile__title")),S=document.querySelector(".profile__description"),b=document.querySelector(".popup_type_edit .popup__form"),q=b.querySelector(".popup__input_type_name"),g=b.querySelector(".popup__input_type_description"),E=document.querySelector(".popup_type_new-card .popup__form"),L=(E.querySelector(".popup__input_type_card-name"),E.querySelector(".popup__input_type_url"),document.querySelector(".profile__title")),k=document.querySelector(".profile__image"),C=document.querySelector(".profile__edit-button"),w=document.querySelector(".popup_type_edit"),x=document.forms["edit-profile"],$=f.querySelector(".popup__form"),j=$.querySelector(".popup__input_type_card-name"),A=$.querySelector(".popup__input_type_url"),T=document.querySelector(".popup_type_edit-avatar"),B=T.querySelector("form"),D=B.querySelector('input[name="avatar"]'),P=B.querySelector('button[type="submit"]'),U=document.querySelector(".profile__avatar-edit-icon"),I=document.querySelector(".places__list");function N(e,t){const r=document.querySelector(".popup_type_image"),o=r.querySelector(".popup__image"),c=r.querySelector(".popup__caption");o.src=t,o.alt=e,c.textContent=e,n(r)}[{name:"Архыз",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/arkhyz.jpg"},{name:"Челябинская область",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/chelyabinsk-oblast.jpg"},{name:"Иваново",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/ivanovo.jpg"},{name:"Камчатка",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/kamchatka.jpg"},{name:"Холмогорский район",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/kholmogorsky-rayon.jpg"},{name:"Байкал",link:"https://pictures.s3.yandex.net/frontend-developer/cards-compressed/baikal.jpg"}].forEach((e=>{const n=t(e,r,o,N);_.append(n)})),document.querySelector(".profile__edit-button").addEventListener("click",(()=>{q.value=v.textContent,g.value=S.textContent,n(y)})),document.querySelector(".profile__add-button").addEventListener("click",(()=>{n(f)})),document.querySelectorAll(".popup__close").forEach((e=>{e.addEventListener("click",(()=>{c(e.closest(".popup"))}))})),document.querySelectorAll(".popup").forEach((e=>{e.addEventListener("mousedown",(t=>{t.target.classList.contains("popup")&&c(e)}))}));const z={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};!function(e){document.querySelectorAll(e.formSelector).forEach((t=>{t.addEventListener("submit",(e=>e.preventDefault())),function(e,t){e.querySelectorAll(t.inputSelector).forEach((r=>{r.addEventListener("input",(()=>{u(e,r,t),p(e,t)})),r.addEventListener("blur",(()=>{u(e,r,t)}))})),p(e,t)}(t,e)}))}(z),function(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=e.querySelectorAll(t.inputSelector),n=e.querySelector(t.submitButtonSelector);o.forEach((o=>{i(e,o,t),r&&(o.value="")})),n&&(n.disabled=!0,n.classList.add(t.inactiveButtonClass))}(document.forms["edit-profile"],z),C.addEventListener("click",(function(){d().then((e=>{x.elements.name.value=e.name,x.elements.description.value=e.about,n(w)})).catch((e=>console.error("Ошибка при загрузке данных пользователя:",e)))})),x.addEventListener("submit",(function(e){e.preventDefault();const t=x.querySelector(".popup__button");var r,o;t.textContent="Сохранение...",(r=x.elements.name.value,o=x.elements.description.value,fetch(`${l.baseUrl}/users/me`,{method:"PATCH",headers:l.headers,body:JSON.stringify({name:r,about:o})}).then(m)).then((e=>{H(e),c(w)})).catch((e=>console.error("Ошибка при обновлении профиля:",e))).finally((()=>{t.textContent="Сохранить"}))})),$.addEventListener("submit",(function(e){e.preventDefault();const n=e.target.querySelector("button[type='submit']"),s=j.value.trim(),a=A.value.trim();s&&a?(n.textContent="Сохранение...",function(e,t){return fetch(`${l.baseUrl}/cards`,{method:"POST",headers:l.headers,body:JSON.stringify({name:e,link:t})}).then(m)}(s,a).then((e=>{const n=t(e,O,e.owner._id,r,((e,t,r)=>o(e,t,r)),N);I.prepend(n),c(f),$.reset()})).catch((e=>console.error("Ошибка при добавлении карточки:",e))).finally((()=>{n.textContent="Сохранить"}))):console.error("Название и ссылка обязательны")}));let O="";function H(e){L.textContent=e.name,S.textContent=e.about,k.style.backgroundImage=`url('${e.avatar}')`}document.addEventListener("DOMContentLoaded",(()=>{Promise.all([d(),fetch(`${l.baseUrl}/cards`,{headers:l.headers}).then(m)]).then((e=>{let[n,c]=e;O=n._id,H(n),function(e){I.innerHTML="",e.forEach((e=>{const n=t(e,O,e.owner._id,r,((e,t,r)=>o(e,t,r)),N);I.appendChild(n)}))}(c)})).catch((e=>console.error("Ошибка при загрузке данных:",e)))})),B.addEventListener("submit",(e=>{e.preventDefault();const t=D.value;var r;(r=t,fetch(r,{method:"HEAD"}).then((e=>{const t=e.headers.get("Content-Type");if(!e.ok)throw new Error(`Сервер вернул статус: ${e.status}`);if(!t.startsWith("image/"))throw new Error(`Ссылка не ведёт на изображение (Content-Type: ${t})`);return!0}))).then((()=>{return P.textContent="Сохранение...",e=t,fetch(`${l.baseUrl}/users/me/avatar`,{method:"PATCH",headers:l.headers,body:JSON.stringify({avatar:e})}).then(m);var e})).then((e=>{k.style.backgroundImage=`url(${e.avatar})`,c(T),B.reset()})).catch((e=>{console.error("Ошибка при проверке или обновлении:",e),function(e,t){const r=document.getElementById(e),o=document.getElementById(`${e}-error`);r.classList.add("popup__input_type_error"),o.textContent=t}("avatar-url",e.message||"Ошибка при валидации ссылки")})).finally((()=>{P.textContent="Сохранить"}))})),D.addEventListener("input",(()=>{D.validity.valid?D.classList.remove("popup__input_type_error"):D.classList.add("popup__input_type_error")})),U.addEventListener("click",(()=>n(T)))})();